name: Delete All Workflow Runs

on:
  workflow_dispatch:

jobs:
  delete-runs:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete all workflow runs
        run: |
          echo "Fetching list of workflows..."
          workflows=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows | jq -r '.workflows[].id')

          for wid in $workflows; do
            echo "Deleting runs for workflow ID: $wid"

            # 获取全部运行记录
            runs=$(curl -s \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/workflows/$wid/runs?per_page=100 | jq -r '.workflow_runs[].id')

            for rid in $runs; do
              echo "Deleting run ID: $rid"
              curl -s -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                https://api.github.com/repos/${{ github.repository }}/actions/runs/$rid
            done
          done

          echo "All workflow runs deleted."
